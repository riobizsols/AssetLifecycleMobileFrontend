# Resolve react_native_pods.rb with node to allow for hoisting
require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

platform :ios, min_ios_version_supported
prepare_react_native_project!

linkage = ENV['USE_FRAMEWORKS']
if linkage != nil
  Pod::UI.puts "Configuring Pod with #{linkage}ally linked Frameworks".green
  use_frameworks! :linkage => linkage.to_sym
else
  # Use static frameworks to fix Firebase Swift pod integration
  use_frameworks! :linkage => :static
end

target 'AssetManagementApp' do
  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  post_install do |installer|
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false,
      # :ccache_enabled => true
    )
    
    # Disable sandboxing for user scripts to fix rsync permission issues
    # This is necessary for the Embed Pods Frameworks script to access DerivedData
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # Disable user script sandboxing to allow rsync to access DerivedData
        config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
      end
    end
    
    # Also disable sandboxing in the main app target
    main_project = Xcodeproj::Project.open(File.join(__dir__, 'AssetManagementApp.xcodeproj'))
    main_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
      end
    end
    main_project.save
    
    # Disable non-modular include warnings when using static frameworks
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # Disable the error for non-modular includes in framework modules
        config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'
        
        # Remove the error flag from WARNING_CFLAGS if it exists
        warning_cflags = config.build_settings['WARNING_CFLAGS']
        if warning_cflags
          if warning_cflags.is_a?(String)
            warning_cflags = warning_cflags.gsub(/-Werror=non-modular-include-in-framework-module/, '')
            config.build_settings['WARNING_CFLAGS'] = warning_cflags
          elsif warning_cflags.is_a?(Array)
            warning_cflags.reject! { |flag| flag.include?('non-modular-include-in-framework-module') }
          end
        end
        
        # Add flag to disable non-modular include error for both C and C++
        ['OTHER_CFLAGS', 'OTHER_CPLUSPLUSFLAGS'].each do |flag_key|
          flags = config.build_settings[flag_key] ||= ['$(inherited)']
          if flags.is_a?(String)
            flags = flags + ' -Wno-error=non-modular-include-in-framework-module' unless flags.include?('-Wno-error=non-modular-include-in-framework-module')
            config.build_settings[flag_key] = flags
          elsif flags.is_a?(Array)
            flags << '-Wno-error=non-modular-include-in-framework-module' unless flags.include?('-Wno-error=non-modular-include-in-framework-module')
          end
        end
      end
    end
    
    # Enable modular headers for Firebase and Google pods to fix Swift pod integration
    installer.pods_project.targets.each do |target|
      if target.name.start_with?('Firebase') || 
         target.name.start_with?('GoogleUtilities') || 
         target.name.start_with?('GoogleDataTransport') ||
         target.name.start_with?('PromisesObjC') ||
         target.name.start_with?('nanopb')
        target.build_configurations.each do |config|
          config.build_settings['DEFINES_MODULE'] = 'YES'
          config.build_settings['CLANG_ENABLE_MODULES'] = 'YES'
        end
      end
    end
    
    # Add codegen output directory to header search paths for TurboModule specs
    # The codegen directory is relative to the ios directory (where Podfile is located)
    # __dir__ is the directory containing the Podfile, which is the ios directory
    codegen_dir_absolute = File.expand_path(File.join(__dir__, 'build/generated/ios'))
    
    # Use absolute path - this works reliably in all contexts
    codegen_path = "\"#{codegen_dir_absolute}\""
    
    installer.pods_project.targets.each do |target|
      # Only add to targets that might need codegen headers (especially RNShare)
      next unless target.name == 'RNShare' || target.name.include?('React') || target.name.include?('Spec')
      
      target.build_configurations.each do |config|
        header_search_paths = config.build_settings['HEADER_SEARCH_PATHS'] ||= ['$(inherited)']
        
        # Convert to array if it's a string
        if header_search_paths.is_a?(String)
          header_search_paths = header_search_paths.split(' ').reject(&:empty?)
        end
        
        # Ensure it's an array
        header_search_paths = [header_search_paths] unless header_search_paths.is_a?(Array)
        header_search_paths.flatten!
        
        # Check if the path is already present
        has_codegen_path = header_search_paths.any? { |path| 
          path.include?('build/generated/ios') || 
          path == codegen_path ||
          path.include?(codegen_dir_absolute)
        }
        
        unless has_codegen_path
          header_search_paths << codegen_path
          config.build_settings['HEADER_SEARCH_PATHS'] = header_search_paths
          Pod::UI.puts "Added codegen header search path to #{target.name}" if config.name == 'Debug'
        end
      end
    end
    
    # Also add to xcconfig files directly for RNShare to ensure it's applied
    # This is necessary because xcconfig files can override project build settings
    ['RNShare.debug.xcconfig', 'RNShare.release.xcconfig'].each do |xcconfig_name|
      xcconfig_path = File.join(installer.sandbox.root, 'Target Support Files/RNShare', xcconfig_name)
      if File.exist?(xcconfig_path)
        xcconfig_content = File.read(xcconfig_path)
        # Check if the codegen path is already in the xcconfig
        unless xcconfig_content.include?('build/generated/ios')
          # Add the header search path to the HEADER_SEARCH_PATHS line
          xcconfig_content.gsub!(/^(HEADER_SEARCH_PATHS = .+)$/, "\\1 #{codegen_path}")
          File.write(xcconfig_path, xcconfig_content)
          Pod::UI.puts "Added codegen header search path to #{xcconfig_name}"
        end
      end
    end
    
    # Fix React-logger umbrella header and disable module verification
    installer.pods_project.targets.each do |target|
      if target.name == 'React-logger'
        react_native_path = File.join(installer.sandbox.root, '../node_modules/react-native')
        logger_header_path = File.expand_path(File.join(react_native_path, 'ReactCommon/logger'))
        
        target.build_configurations.each do |config|
          # Configure module settings for framework compatibility
          config.build_settings['CLANG_ENABLE_MODULES'] = 'YES'
          config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'
          
          # Add header search path for react_native_log.h
          header_search_paths = config.build_settings['HEADER_SEARCH_PATHS'] ||= ['$(inherited)']
          if header_search_paths.is_a?(String)
            header_search_paths = header_search_paths.split(' ').reject(&:empty?)
          end
          header_search_paths = [header_search_paths] unless header_search_paths.is_a?(Array)
          header_search_paths.flatten!
          
          logger_path_quoted = "\"#{logger_header_path}\""
          unless header_search_paths.include?(logger_path_quoted) || header_search_paths.any? { |p| p.include?('ReactCommon/logger') }
            header_search_paths << logger_path_quoted
            config.build_settings['HEADER_SEARCH_PATHS'] = header_search_paths
          end
        end
        
        # Remove the VerifyModule build phase if it exists
        target.build_phases.each do |phase|
          if phase.is_a?(Xcodeproj::Project::Object::PBXShellScriptBuildPhase) && 
             (phase.name == 'VerifyModule' || phase.shell_script.to_s.include?('modules-verifier'))
            target.build_phases.delete(phase)
            Pod::UI.puts "Removed VerifyModule build phase from React-logger"
          end
        end
      end
    end
    
    # Fix React-logger umbrella header to use angle brackets instead of double quotes
    # This is required for framework module verification when using static frameworks
    umbrella_header_path = File.join(installer.sandbox.root, 'Target Support Files/React-logger/React-logger-umbrella.h')
    if File.exist?(umbrella_header_path)
      umbrella_content = File.read(umbrella_header_path)
      # Replace double-quoted include with angle-bracketed include for framework compatibility
      if umbrella_content.include?('#import "react_native_log.h"')
        # Use angle brackets which is required for framework headers
        # The header should be accessible via header search paths
        umbrella_content.gsub!(/#import "react_native_log.h"/, '#import <react_native_log.h>')
        File.write(umbrella_header_path, umbrella_content)
        Pod::UI.puts "Fixed React-logger umbrella header to use angle brackets"
      end
    end
    
    # Ensure react-native-vector-icons fonts are copied to the app bundle
    # The RNVectorIcons pod should handle this, but we ensure it's configured correctly
    installer.pods_project.targets.each do |target|
      if target.name == 'RNVectorIcons'
        target.build_configurations.each do |config|
          # Ensure resources are properly included
          config.build_settings['COPY_PHASE_STRIP'] = 'NO'
        end
        Pod::UI.puts "Configured RNVectorIcons for font resources"
      end
    end
  end
end
